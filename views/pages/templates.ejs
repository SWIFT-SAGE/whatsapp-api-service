<!-- Message Templates Section -->
<style>
  .templates-container {
    padding: 2rem;
    max-width: 1400px;
    margin: 0 auto;
  }

  .templates-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
  }

  .templates-header h1 {
    font-size: 2rem;
    color: #1f2937;
  }

  .btn-primary-template {
    background: #25d366;
    color: white;
    padding: 0.75rem 1.5rem;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s;
  }

  .btn-primary-template:hover {
    background: #20ba5a;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(37, 211, 102, 0.3);
  }

  .templates-tabs {
    display: flex;
    gap: 1rem;
    margin-bottom: 2rem;
    border-bottom: 2px solid #e5e7eb;
  }

  .templates-tab {
    padding: 0.75rem 1.5rem;
    background: none;
    border: none;
    color: #6b7280;
    font-weight: 600;
    cursor: pointer;
    position: relative;
    transition: all 0.3s;
  }

  .templates-tab.active {
    color: #25d366;
  }

  .templates-tab.active::after {
    content: '';
    position: absolute;
    bottom: -2px;
    left: 0;
    right: 0;
    height: 2px;
    background: #25d366;
  }

  .templates-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: 1.5rem;
  }

  .template-card {
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 12px;
    padding: 1.5rem;
    transition: all 0.3s;
    cursor: pointer;
  }

  .template-card:hover {
    border-color: #25d366;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    transform: translateY(-2px);
  }

  .template-card-header {
    display: flex;
    justify-content: space-between;
    align-items: start;
    margin-bottom: 1rem;
  }

  .template-name {
    font-size: 1.25rem;
    font-weight: 700;
    color: #1f2937;
    margin-bottom: 0.5rem;
  }

  .template-category {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    background: #eff6ff;
    color: #1e40af;
    border-radius: 999px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
  }

  .template-category.marketing { background: #fef3c7; color: #92400e; }
  .template-category.transactional { background: #dbeafe; color: #1e40af; }
  .template-category.notification { background: #fce7f3; color: #9f1239; }
  .template-category.custom { background: #e0e7ff; color: #4338ca; }
  .template-category.built-in { background: #d1fae5; color: #065f46; }

  .template-type {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    background: #f3f4f6;
    border-radius: 8px;
    font-size: 0.875rem;
    color: #6b7280;
    margin-bottom: 1rem;
  }

  .template-preview {
    background: #f9fafb;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 1rem;
    font-size: 0.875rem;
    color: #4b5563;
    white-space: pre-wrap;
    max-height: 150px;
    overflow-y: auto;
  }

  .template-stats {
    display: flex;
    gap: 1.5rem;
    margin-bottom: 1rem;
    padding-top: 1rem;
    border-top: 1px solid #e5e7eb;
  }

  .template-stat {
    display: flex;
    flex-direction: column;
  }

  .stat-label {
    font-size: 0.75rem;
    color: #6b7280;
    text-transform: uppercase;
    font-weight: 600;
  }

  .stat-value {
    font-size: 1.25rem;
    font-weight: 700;
    color: #1f2937;
  }

  .template-actions {
    display: flex;
    gap: 0.5rem;
  }

  .btn-icon-template {
    padding: 0.5rem;
    border: 1px solid #e5e7eb;
    background: white;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.3s;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .btn-icon-template:hover {
    border-color: #25d366;
    background: #f0fdf4;
  }

  .template-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    z-index: 10000;
    align-items: center;
    justify-content: center;
  }

  .template-modal.active {
    display: flex;
  }

  .template-modal-content {
    background: white;
    border-radius: 16px;
    padding: 2rem;
    max-width: 600px;
    width: 90%;
    max-height: 90vh;
    overflow-y: auto;
  }

  .template-modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
  }

  .template-modal-header h2 {
    font-size: 1.5rem;
    color: #1f2937;
  }

  .template-close-btn {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: #6b7280;
  }

  .template-form-group {
    margin-bottom: 1.5rem;
  }

  .template-form-group label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 600;
    color: #374151;
  }

  .template-form-group input,
  .template-form-group select,
  .template-form-group textarea {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid #d1d5db;
    border-radius: 8px;
    font-size: 1rem;
  }

  .template-form-group textarea {
    min-height: 150px;
    resize: vertical;
  }

  .template-form-group small {
    display: block;
    margin-top: 0.25rem;
    color: #6b7280;
    font-size: 0.875rem;
  }

  .variable-chips {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-top: 0.5rem;
  }

  .variable-chip {
    padding: 0.25rem 0.75rem;
    background: #dbeafe;
    color: #1e40af;
    border-radius: 999px;
    font-size: 0.875rem;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
  }

  .variable-chip button {
    background: none;
    border: none;
    color: #1e40af;
    cursor: pointer;
    font-size: 1rem;
    padding: 0;
  }

  .btn-secondary-template {
    background: #e5e7eb;
    color: #374151;
    padding: 0.75rem 1.5rem;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    margin-right: 0.5rem;
  }

  .template-empty-state {
    text-align: center;
    padding: 4rem 2rem;
    color: #6b7280;
  }

  .template-empty-state svg {
    width: 64px;
    height: 64px;
    margin: 0 auto 1rem;
    opacity: 0.3;
  }

  .template-loading {
    text-align: center;
    padding: 3rem;
    color: #6b7280;
  }

  .template-spinner {
    border: 3px solid #f3f4f6;
    border-top: 3px solid #25d366;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    animation: template-spin 1s linear infinite;
    margin: 0 auto 1rem;
  }

  @keyframes template-spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  .button-item, .section-item {
    background: #f9fafb;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 0.75rem;
  }

  .button-item-header, .section-item-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.75rem;
  }

  .button-item-header h4, .section-item-header h4 {
    font-size: 0.875rem;
    font-weight: 600;
    color: #374151;
  }

  .remove-btn {
    background: #fee2e2;
    color: #dc2626;
    border: none;
    padding: 0.25rem 0.75rem;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.75rem;
    font-weight: 600;
  }

  .remove-btn:hover {
    background: #fecaca;
  }

  .button-type-selector {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 0.75rem;
  }

  .button-type-option {
    flex: 1;
    padding: 0.5rem;
    border: 2px solid #e5e7eb;
    border-radius: 6px;
    cursor: pointer;
    text-align: center;
    font-size: 0.875rem;
    background: white;
    transition: all 0.2s;
  }

  .button-type-option:hover {
    border-color: #25d366;
  }

  .button-type-option.active {
    border-color: #25d366;
    background: #f0fdf4;
    color: #166534;
    font-weight: 600;
  }

  .row-item {
    background: #ffffff;
    border: 1px solid #e5e7eb;
    border-radius: 6px;
    padding: 0.75rem;
    margin-bottom: 0.5rem;
  }
</style>

<div class="templates-container">
  <div class="templates-header">
    <h1>üìù Message Templates</h1>
    <button class="btn-primary-template" onclick="window.templateFunctions.openCreateModal()">+ Create Template</button>
    </div>

  <div class="templates-tabs">
    <button class="templates-tab active" data-tab="all" onclick="window.templateFunctions.switchTab('all')">All Templates</button>
    <button class="templates-tab" data-tab="custom" onclick="window.templateFunctions.switchTab('custom')">Custom</button>
    <button class="templates-tab" data-tab="marketing" onclick="window.templateFunctions.switchTab('marketing')">Marketing</button>
    <button class="templates-tab" data-tab="transactional" onclick="window.templateFunctions.switchTab('transactional')">Transactional</button>
        </div>

  <div id="templates-content" class="template-loading">
    <div class="template-spinner"></div>
    <p>Loading templates...</p>
                    </div>
                </div>

<!-- Create/Edit Template Modal -->
<div id="template-modal" class="template-modal">
  <div class="template-modal-content">
    <div class="template-modal-header">
      <h2 id="modal-title">Create Template</h2>
      <button class="template-close-btn" onclick="window.templateFunctions.closeModal()">&times;</button>
            </div>
    <form id="template-form" onsubmit="return window.templateFunctions.saveTemplate(event)">
      <div class="template-form-group">
        <label>Template Name *</label>
        <input type="text" name="name" required placeholder="e.g., Order Confirmation">
        </div>

      <div class="template-form-group">
        <label>Category</label>
        <select name="category">
          <option value="custom">Custom</option>
                            <option value="marketing">Marketing</option>
          <option value="transactional">Transactional</option>
          <option value="notification">Notification</option>
                        </select>
                </div>

      <div class="template-form-group">
        <label>Type</label>
        <select name="type" onchange="window.templateFunctions.handleTypeChange(this.value)">
          <option value="text">üìù Text Message</option>
          <option value="product">üì¶ Product</option>
          <option value="order">üìã Order</option>
          <option value="poll">üìä Poll</option>
          <option value="list">üìë List</option>
        </select>
                </div>

      <!-- Text Message Configuration -->
      <div id="text-config">
        <div class="template-form-group">
          <label>Message Content *</label>
          <textarea name="text" placeholder="Use {{variableName}} for dynamic content

Example:
Hi *{{name}}*!

Your order {{orderId}} has been confirmed.
Amount: ‚Çπ{{amount}}

Thank you!"></textarea>
          <small>Use *text* for bold, _text_ for italic, ~text~ for strikethrough</small>
            </div>
        </div>

      <!-- Product Configuration -->
      <div id="product-config" style="display: none;">
        <div class="template-form-group">
          <label>Product Image URL *</label>
          <input type="url" name="productImage" placeholder="https://example.com/product.jpg">
          <small>Public HTTPS URL to product image</small>
                </div>
        
        <div class="template-form-group">
          <label>Product ID *</label>
          <input type="text" name="productId" placeholder="PROD-2024-001">
          <small>Unique product identifier. Use {{variables}} if needed</small>
            </div>
        
        <div class="template-form-group">
          <label>Product Title *</label>
          <input type="text" name="title" placeholder="Premium Wireless Headphones">
          <small>Product name/title</small>
        </div>

        <div class="template-form-group">
          <label>Product Description *</label>
          <textarea name="productDescription" placeholder="High-quality noise-canceling headphones with 30-hour battery life. Perfect for music lovers and professionals."></textarea>
          <small>Detailed product description</small>
                </div>
        
        <div class="template-form-group">
          <label>Currency Code *</label>
          <select name="currencyCode">
            <option value="INR">INR (‚Çπ)</option>
            <option value="USD">USD ($)</option>
            <option value="EUR">EUR (‚Ç¨)</option>
            <option value="GBP">GBP (¬£)</option>
          </select>
            </div>
        
        <div class="template-form-group">
          <label>Price (Actual Amount) *</label>
          <input type="number" name="priceAmount" placeholder="4999" step="0.01">
          <small>Enter actual price (e.g., 4999 for ‚Çπ4,999). Will be converted automatically.</small>
        </div>
        
        <div class="template-form-group">
          <label>Product URL</label>
          <input type="url" name="productUrl" placeholder="https://yourstore.com/products/headphones">
          <small>Link to product page</small>
        </div>
        
        <div class="template-form-group">
          <label>Retailer/SKU ID</label>
          <input type="text" name="retailerId" placeholder="SKU-WH-001">
          <small>SKU or retailer identifier</small>
    </div>
</div>

      <!-- Order Configuration -->
      <div id="order-config" style="display: none;">
        <div class="template-form-group">
          <label>Order ID *</label>
          <input type="text" name="orderId" placeholder="ORD-2024-001 or {{orderId}}">
          <small>Unique order identifier. Use {{variables}} for dynamic values</small>
            </div>
        
        <div class="template-form-group">
          <label>Order Title *</label>
          <input type="text" name="orderTitle" placeholder="Your Order Confirmation">
                    </div>

        <div class="template-form-group">
          <label>Order Message *</label>
          <textarea name="orderMessage" placeholder="Thank you for your order! We will process it shortly and send tracking details."></textarea>
          <small>Message to customer about the order</small>
        </div>
        
        <div class="template-form-group">
          <label>Thumbnail Image URL</label>
          <input type="url" name="thumbnail" placeholder="https://example.com/order-thumb.jpg">
          <small>Order thumbnail image</small>
        </div>
        
        <div class="template-form-group">
          <label>Order Status *</label>
          <select name="orderStatus">
            <option value="pending">Pending</option>
            <option value="processing">Processing</option>
            <option value="shipped">Shipped</option>
            <option value="delivered">Delivered</option>
            <option value="cancelled">Cancelled</option>
                        </select>
                    </div>

        <div class="template-form-group">
          <label>Total Amount (Actual) *</label>
          <input type="number" name="totalAmount" placeholder="15497" step="0.01">
          <small>Total order amount. Will be converted automatically.</small>
                    </div>

        <div class="template-form-group">
          <label>Currency *</label>
          <select name="totalCurrencyCode">
            <option value="INR">INR (‚Çπ)</option>
            <option value="USD">USD ($)</option>
            <option value="EUR">EUR (‚Ç¨)</option>
            <option value="GBP">GBP (¬£)</option>
          </select>
        </div>
        
        <div class="template-form-group">
          <label>Order Items</label>
          <div id="order-items-list"></div>
          <button type="button" onclick="window.templateFunctions.addOrderItem()" class="btn-secondary-template" style="margin-top: 0.5rem;">+ Add Item</button>
          <small>Add products included in this order</small>
                        </div>
                    </div>

      <!-- Poll Configuration -->
      <div id="poll-config" style="display: none;">
        <div class="template-form-group">
          <label>Poll Question *</label>
          <input type="text" name="pollName" placeholder="How satisfied are you with our service?" maxlength="255">
          <small>Max 255 characters. Use {{variables}} if needed</small>
                    </div>

        <div class="template-form-group">
          <label>Selection Type *</label>
          <select name="selectableOptionsCount">
            <option value="1">Single Choice (Radio)</option>
            <option value="2">Multiple Choice - Max 2</option>
            <option value="3">Multiple Choice - Max 3</option>
            <option value="0">Unlimited Choices</option>
          </select>
                        </div>
        
        <div class="template-form-group">
          <label>Poll Options (2-12 options) *</label>
          <div id="poll-options-list"></div>
          <button type="button" onclick="window.templateFunctions.addPollOption()" class="btn-secondary-template" style="margin-top: 0.5rem;">+ Add Option</button>
          <small>Minimum 2 options, maximum 12 options. Max 100 chars per option.</small>
                    </div>
            </div>

      <!-- List Configuration -->
      <div id="list-config" style="display: none;">
        <div class="template-form-group">
          <label>List Body Text</label>
          <textarea name="listBody" placeholder="Main message text"></textarea>
            </div>
        
        <div class="template-form-group">
          <label>List Button Text</label>
          <input type="text" name="listButtonText" placeholder="e.g., View Options">
        </div>

        <div class="template-form-group">
          <label>List Title</label>
          <input type="text" name="listTitle" placeholder="e.g., Select Service">
    </div>

        <div class="template-form-group">
          <label>List Footer</label>
          <input type="text" name="listFooter" placeholder="e.g., Contact us for help">
</div>

        <div class="template-form-group">
          <label>List Sections</label>
          <div id="sections-list"></div>
          <button type="button" onclick="window.templateFunctions.addSection()" class="btn-secondary-template" style="margin-top: 0.5rem;">+ Add Section</button>
            </div>
                        </div>

      <div class="template-form-group">
        <label>Variables</label>
        <input type="text" id="variable-input" placeholder="Add variable name (e.g., name, orderId)" onkeypress="if(event.key === 'Enter') { event.preventDefault(); window.templateFunctions.addVariable(); }">
        <button type="button" onclick="window.templateFunctions.addVariable()" class="btn-secondary-template" style="margin-top: 0.5rem;">+ Add Variable</button>
        <div id="variables-list" class="variable-chips"></div>
        <small>Variables can be used in your template like {{name}}</small>
                    </div>

      <div class="template-form-group">
        <label>Description</label>
        <input type="text" name="description" placeholder="Brief description of this template">
                </div>
                
      <div style="display: flex; justify-content: flex-end; gap: 0.5rem; margin-top: 2rem;">
        <button type="button" class="btn-secondary-template" onclick="window.templateFunctions.closeModal()">Cancel</button>
        <button type="submit" class="btn-primary-template">Save Template</button>
                    </div>
                    </form>
                    </div>
                </div>

<!-- Send Template Modal -->
<div id="send-modal" class="template-modal">
  <div class="template-modal-content">
    <div class="template-modal-header">
      <h2>Send Template</h2>
      <button class="template-close-btn" onclick="window.templateFunctions.closeSendModal()">&times;</button>
            </div>
    <form id="send-form" onsubmit="return window.templateFunctions.sendTemplate(event)">
      <input type="hidden" id="send-template-id">
      
      <div class="template-form-group">
        <label>Session ID *</label>
        <input type="text" name="sessionId" required placeholder="session_xxxxx">
      </div>

      <div class="template-form-group">
        <label>Recipient Number *</label>
        <input type="text" name="to" required placeholder="919876543210">
        <small>Enter phone number with country code (no + or spaces)</small>
            </div>

      <div id="send-variables"></div>

      <div style="display: flex; justify-content: flex-end; gap: 0.5rem; margin-top: 2rem;">
        <button type="button" class="btn-secondary-template" onclick="window.templateFunctions.closeSendModal()">Cancel</button>
        <button type="submit" class="btn-primary-template">Send Message</button>
        </div>
    </form>
    </div>
</div>

<script>
(function() {
  console.log('Templates page script loaded');
  
  // Global state
  let currentTab = 'all';
  let allTemplates = [];
  let currentVariables = [];

  // Initialize templates when script loads
  setTimeout(() => {
    console.log('Initializing templates...');
    loadTemplates();
  }, 500);

  async function loadTemplates() {
    console.log('=== loadTemplates called ===');
    try {
      console.log('Fetching templates from API...');
      const customRes = await fetch('/api/templates', {
        credentials: 'include'
      });

      console.log('Custom templates response:', customRes.status);

      if (!customRes.ok) {
        throw new Error(`HTTP Error: ${customRes.status}`);
      }

      const customData = await customRes.json();
      allTemplates = customData.data || [];

      console.log('Templates loaded:', {
        custom: allTemplates.length
      });

      displayTemplates();
    } catch (error) {
      console.error('Error loading templates:', error);
      const container = document.getElementById('templates-content');
      if (container) {
        container.innerHTML = `
          <div class="template-empty-state">
            <h3>Error loading templates</h3>
            <p>${error.message}</p>
            <button class="btn-primary-template" onclick="location.reload()">Refresh Page</button>
            </div>
        `;
      }
    }
  }

  function switchTab(tab) {
    currentTab = tab;
    document.querySelectorAll('.templates-tab').forEach(t => t.classList.remove('active'));
    const activeTab = document.querySelector(`[data-tab="${tab}"]`);
    if (activeTab) activeTab.classList.add('active');
    displayTemplates();
  }

  function displayTemplates() {
    console.log('Displaying templates for tab:', currentTab);
    console.log('allTemplates:', allTemplates);
    
    let filtered = [];

    if (currentTab === 'all') {
      filtered = allTemplates;
    } else if (currentTab === 'custom') {
      filtered = allTemplates.filter(t => t.category === 'custom' || !t.category);
    } else {
      filtered = allTemplates.filter(t => t.category === currentTab);
    }

    const container = document.getElementById('templates-content');
    if (!container) return;

    if (filtered.length === 0) {
      container.innerHTML = `
        <div class="template-empty-state">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
          </svg>
          <h3>No templates found</h3>
          <p>Create your first template to get started</p>
                        </div>
      `;
      return;
    }

    const cardsHTML = filtered.map(template => renderTemplateCard(template)).join('');
    container.innerHTML = `<div class="templates-grid">${cardsHTML}</div>`;
  }

  function renderTemplateCard(template) {
    let preview = '';
    
    if (template.description) {
      preview = template.description;
    } else if (template.content?.text) {
      preview = template.content.text.substring(0, 150);
    } else {
      preview = 'No preview available';
    }

    return `
      <div class="template-card" onclick="window.templateFunctions.selectTemplate('${template._id || template.name}', false)">
        <div class="template-card-header">
          <div>
            <div class="template-name">${template.name}</div>
            <span class="template-category ${template.category}">${template.category || 'custom'}</span>
                    </div>
                </div>
                
        <div class="template-type">
          ${getTypeIcon(template.type)} ${template.type || 'text'}
        </div>
        
        <div class="template-preview">${preview}</div>
        
        ${!template.isBuiltIn ? `
          <div class="template-stats">
            <div class="template-stat">
              <span class="stat-label">Used</span>
              <span class="stat-value">${template.usageCount || 0}</span>
                    </div>
            <div class="template-stat">
              <span class="stat-label">Variables</span>
              <span class="stat-value">${template.variables?.length || 0}</span>
                    </div>
                </div>
        ` : `
          <div class="template-stats">
            <div class="template-stat">
              <span class="stat-label">Variables</span>
              <span class="stat-value">${template.variables?.length || 0}</span>
                </div>
            </div>
        `}
        
        <div class="template-actions">
          <button class="btn-icon-template" onclick="event.stopPropagation(); window.templateFunctions.openSendModal('${template._id || template.name}', false)" title="Send">
            üì§
                </button>
          ${true ? `
            <button class="btn-icon-template" onclick="event.stopPropagation(); window.templateFunctions.editTemplate('${template._id}')" title="Edit">
              ‚úèÔ∏è
            </button>
            <button class="btn-icon-template" onclick="event.stopPropagation(); window.templateFunctions.deleteTemplate('${template._id}')" title="Delete">
              üóëÔ∏è
                </button>
          ` : ''}
            </div>
        </div>
    `;
  }

  function getTypeIcon(type) {
    const icons = {
      text: 'üí¨',
      media: 'üñºÔ∏è',
      button: 'üîò',
      buttons: 'üîò',
      list: 'üìã',
      interactive: '‚ö°'
    };
    return icons[type] || 'üí¨';
  }

  function selectTemplate(templateId, isBuiltIn) {
    console.log('Selected template:', templateId);
  }

  function openCreateModal() {
    document.getElementById('modal-title').textContent = 'Create Template';
    document.getElementById('template-form').reset();
    delete document.getElementById('template-form').dataset.editId;
    currentVariables = [];
    currentPollOptions = [];
    currentOrderItems = [];
    currentSections = [];
    document.getElementById('variables-list').innerHTML = '';
    document.getElementById('poll-options-list').innerHTML = '';
    document.getElementById('order-items-list').innerHTML = '';
    document.getElementById('sections-list').innerHTML = '';
    handleTypeChange('text');
    document.getElementById('template-modal').classList.add('active');
  }

  function closeModal() {
    document.getElementById('template-modal').classList.remove('active');
    currentPollOptions = [];
    currentOrderItems = [];
    currentSections = [];
  }

  async function editTemplate(templateId) {
    try {
      const response = await fetch(`/api/templates/${templateId}`, {
        credentials: 'include'
      });
      
      if (!response.ok) throw new Error('Failed to fetch template');
      
      const result = await response.json();
      if (!result.success || !result.data) throw new Error('Template not found');
      
      const template = result.data;
      
      document.getElementById('modal-title').textContent = 'Edit Template';
      document.querySelector('[name="name"]').value = template.name || '';
      document.querySelector('[name="category"]').value = template.category || 'custom';
      document.querySelector('[name="type"]').value = template.type || 'text';
      document.querySelector('[name="text"]').value = template.content?.text || '';
      document.querySelector('[name="mediaUrl"]').value = template.content?.mediaUrl || '';
      document.querySelector('[name="description"]').value = template.description || '';
      
      currentVariables = template.variables || [];
      renderVariables();
      
      document.getElementById('template-form').dataset.editId = templateId;
      document.getElementById('template-modal').classList.add('active');
    } catch (error) {
      alert('Failed to load template: ' + error.message);
    }
  }

  function handleTypeChange(type) {
    // Hide all config sections
    const textConfig = document.getElementById('text-config');
    const productConfig = document.getElementById('product-config');
    const orderConfig = document.getElementById('order-config');
    const pollConfig = document.getElementById('poll-config');
    const listConfig = document.getElementById('list-config');
    
    if (textConfig) textConfig.style.display = 'none';
    if (productConfig) productConfig.style.display = 'none';
    if (orderConfig) orderConfig.style.display = 'none';
    if (pollConfig) pollConfig.style.display = 'none';
    if (listConfig) listConfig.style.display = 'none';
    
    // Show the selected config section
    switch(type) {
      case 'text':
        if (textConfig) textConfig.style.display = 'block';
        break;
      case 'product':
        if (productConfig) productConfig.style.display = 'block';
        break;
      case 'order':
        if (orderConfig) orderConfig.style.display = 'block';
        break;
      case 'poll':
        if (pollConfig) pollConfig.style.display = 'block';
        // Initialize with 2 poll options if empty
        if (currentPollOptions.length === 0) {
          addPollOption();
          addPollOption();
        }
        break;
      case 'list':
        if (listConfig) listConfig.style.display = 'block';
        break;
    }
  }

  function addVariable() {
    const input = document.getElementById('variable-input');
    if (!input) return;
    
    const variable = input.value.trim();
    if (!variable) {
      alert('Please enter a variable name');
      return;
    }
    
    if (currentVariables.includes(variable)) {
      alert(`Variable "${variable}" already exists`);
      return;
    }
    
    currentVariables.push(variable);
    renderVariables();
    input.value = '';
  }

  function removeVariable(variable) {
    currentVariables = currentVariables.filter(v => v !== variable);
    renderVariables();
  }

  function renderVariables() {
    const list = document.getElementById('variables-list');
    if (!list) return;
    
    list.innerHTML = currentVariables.map(v => `
      <div class="variable-chip">
        {{${v}}}
        <button type="button" onclick="window.templateFunctions.removeVariable('${v}')">&times;</button>
    </div>
    `).join('');
  }

  async function saveTemplate(event) {
    if (event && event.preventDefault) event.preventDefault();
    
    const form = document.getElementById('template-form');
    if (!form) return false;
    
    const submitButton = form.querySelector('button[type="submit"]');
    if (submitButton?.disabled) return false;
    
    if (submitButton) {
      submitButton.disabled = true;
      submitButton.textContent = 'Saving...';
    }
    
    try {
      const formData = new FormData(form);
      const editId = form.dataset.editId;
      const isEdit = !!editId;
      
      const templateType = formData.get('type') || 'text';
      const contentObj = {};
      
      // Build content based on template type
      switch(templateType) {
        case 'text':
          contentObj.text = formData.get('text') || '';
          break;
          
        case 'product':
          contentObj.productImage = formData.get('productImage') || '';
          contentObj.productId = formData.get('productId') || '';
          contentObj.title = formData.get('title') || '';
          contentObj.productDescription = formData.get('productDescription') || '';
          contentObj.currencyCode = formData.get('currencyCode') || 'INR';
          // Convert actual price to priceAmount1000 format
          const priceAmount = parseFloat(formData.get('priceAmount')) || 0;
          contentObj.priceAmount1000 = Math.round(priceAmount * 1000);
          contentObj.productUrl = formData.get('productUrl') || '';
          contentObj.retailerId = formData.get('retailerId') || '';
          break;
          
        case 'order':
          contentObj.orderId = formData.get('orderId') || '';
          contentObj.orderTitle = formData.get('orderTitle') || '';
          contentObj.orderMessage = formData.get('orderMessage') || '';
          contentObj.thumbnail = formData.get('thumbnail') || '';
          contentObj.orderStatus = formData.get('orderStatus') || 'pending';
          contentObj.surface = 'catalog';
          // Convert actual total to totalAmount1000 format
          const totalAmount = parseFloat(formData.get('totalAmount')) || 0;
          contentObj.totalAmount1000 = Math.round(totalAmount * 1000);
          contentObj.totalCurrencyCode = formData.get('totalCurrencyCode') || 'INR';
          contentObj.itemCount = currentOrderItems.length;
          contentObj.orderItems = currentOrderItems.filter(item => item.productId && item.name);
          break;
          
        case 'poll':
          contentObj.pollName = formData.get('pollName') || '';
          contentObj.pollOptions = currentPollOptions.filter(opt => opt.trim() !== '');
          contentObj.selectableOptionsCount = parseInt(formData.get('selectableOptionsCount')) || 1;
          break;
          
        case 'list':
          contentObj.listBody = formData.get('listBody') || '';
          contentObj.listButtonText = formData.get('listButtonText') || 'View Options';
          contentObj.listTitle = formData.get('listTitle') || '';
          contentObj.listFooter = formData.get('listFooter') || '';
          contentObj.listSections = currentSections.filter(s => s.title.trim() !== '');
          break;
      }
      
      const templateData = {
        name: formData.get('name'),
        category: formData.get('category') || 'custom',
        type: templateType,
        description: formData.get('description') || '',
        content: contentObj,
        variables: currentVariables || [],
        formatting: { useBold: true, useItalic: true, useEmojis: true }
      };

      const url = isEdit ? `/api/templates/${editId}` : '/api/templates';
      const method = isEdit ? 'PUT' : 'POST';
      
      const response = await fetch(url, {
        method,
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify(templateData)
      });

      if (!response.ok) {
        const errorText = await response.text();
        try {
          const errorJson = JSON.parse(errorText);
          throw new Error(errorJson.message || errorJson.error || 'Failed to save template');
        } catch (e) {
          throw new Error(errorText);
        }
      }
      
      const result = await response.json();
      if (result.success) {
        alert(`Template ${isEdit ? 'updated' : 'created'} successfully!`);
        delete form.dataset.editId;
        closeModal();
        await loadTemplates();
      } else {
        throw new Error(result.message || 'Failed to save template');
      }
    } catch (error) {
      alert('Failed to save template: ' + error.message);
    } finally {
      if (submitButton) {
        submitButton.disabled = false;
        submitButton.textContent = 'Save Template';
      }
    }
    
    return false;
  }

  function openSendModal(templateId, isBuiltIn) {
    console.log('Opening send modal for:', templateId);
    
    const input = document.getElementById('send-template-id');
    const modal = document.getElementById('send-modal');
    const variablesContainer = document.getElementById('send-variables');
    
    if (!input || !modal) {
      alert('Modal not found');
      return;
    }
    
    input.value = templateId;
    
    // Get template variables from custom template
    let templateVariables = [];
    const template = allTemplates.find(t => t._id === templateId);
    templateVariables = template?.variables || [];
    console.log('Template found:', template);
    
    console.log('Template variables:', templateVariables);
    
    // Generate variable input fields
    if (templateVariables.length > 0 && variablesContainer) {
      variablesContainer.innerHTML = `
        <div class="template-form-group">
          <label>Template Variables</label>
          ${templateVariables.map(v => `
            <div style="margin-bottom: 1rem;">
              <label style="font-weight: normal; font-size: 0.875rem;">${v}</label>
              <input type="text" name="var_${v}" placeholder="Enter ${v}" class="form-control" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
</div>
          `).join('')}
        </div>
      `;
    } else {
      variablesContainer.innerHTML = '';
    }
    
    modal.classList.add('active');
  }

  function closeSendModal() {
    const modal = document.getElementById('send-modal');
    if (modal) modal.classList.remove('active');
  }

  async function sendTemplate(event) {
    if (event && event.preventDefault) event.preventDefault();
    
    const form = document.getElementById('send-form');
    if (!form) return false;
    
    const formData = new FormData(form);
    const templateId = document.getElementById('send-template-id').value;
    
    // Validate required fields
    const sessionId = formData.get('sessionId');
    const to = formData.get('to');
    
    if (!sessionId || !sessionId.trim()) {
      alert('Please enter Session ID');
      return false;
    }
    
    if (!to || !to.trim()) {
      alert('Please enter recipient phone number');
      return false;
    }
    
    // Collect variables from the form
    const variables = {};
    for (let [key, value] of formData.entries()) {
      if (key.startsWith('var_')) {
        const varName = key.replace('var_', '');
        variables[varName] = value;
      }
    }
    
    console.log('Sending template:', {
      sessionId,
      to,
      templateName: templateId,
      variables
    });
    
    const sendData = {
      sessionId: sessionId.trim(),
      to: to.trim(),
      templateName: templateId,
      variables: variables
    };

    // Disable submit button
    const submitButton = form.querySelector('button[type="submit"]');
    if (submitButton) {
      submitButton.disabled = true;
      submitButton.textContent = 'Sending...';
    }

    try {
      const response = await fetch('/api/templates/send', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify(sendData)
      });

      console.log('Send response status:', response.status);
      const result = await response.json();
      console.log('Send result:', result);

      if (result.success) {
        const message = result.message || 'Template sent successfully!';
        alert(message);
        closeSendModal();
        form.reset();
      } else {
        // Show detailed error message
        let errorMsg = result.message || 'Failed to send template';
        
        // If there are detailed results, show them
        if (result.data && result.data.results && result.data.results.length > 0) {
          const firstError = result.data.results[0];
          if (firstError.error) {
            errorMsg = firstError.error;
          }
        }
        
        alert('Error: ' + errorMsg);
        console.error('Template send failed:', result);
      }
    } catch (error) {
      console.error('Send error:', error);
      alert('Failed to send template: ' + (error.message || 'Network error'));
    } finally {
      if (submitButton) {
        submitButton.disabled = false;
        submitButton.textContent = 'Send Message';
      }
    }
    
    return false;
  }

  async function deleteTemplate(templateId) {
    if (!confirm('Are you sure you want to delete this template?')) return;

    try {
      const response = await fetch(`/api/templates/${templateId}`, {
        method: 'DELETE',
        credentials: 'include'
      });

      if (!response.ok) throw new Error('Failed to delete');

      const result = await response.json();
      if (result.success) {
        alert('Template deleted successfully!');
        await loadTemplates();
      } else {
        throw new Error(result.message || 'Failed to delete');
      }
    } catch (error) {
      alert('Failed to delete template: ' + error.message);
    }
  }

  // Poll Options Management
  let currentPollOptions = [];
  let currentOrderItems = [];
  
  function addPollOption() {
    if (currentPollOptions.length >= 12) {
      alert('Maximum 12 poll options allowed');
      return;
    }
    
    currentPollOptions.push('');
    renderPollOptions();
  }
  
  function removePollOption(index) {
    if (currentPollOptions.length <= 2) {
      alert('Minimum 2 poll options required');
      return;
    }
    currentPollOptions.splice(index, 1);
    renderPollOptions();
  }
  
  function updatePollOption(index, value) {
    currentPollOptions[index] = value;
  }
  
  function renderPollOptions() {
    const container = document.getElementById('poll-options-list');
    if (!container) return;
    
    container.innerHTML = currentPollOptions.map((option, index) => `
      <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem; align-items: center;">
        <span style="font-weight: 600; color: #6b7280; min-width: 2rem;">${index + 1}.</span>
        <input type="text" 
               value="${option}" 
               onchange="window.templateFunctions.updatePollOption(${index}, this.value)"
               placeholder="Option ${index + 1}"
               maxlength="100"
               style="flex: 1; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
        <button type="button" 
                onclick="window.templateFunctions.removePollOption(${index})"
                class="remove-btn"
                style="padding: 0.5rem 0.75rem;">
          Remove
        </button>
      </div>
    `).join('');
  }
  
  // Order Items Management
  function addOrderItem() {
    const item = {
      productId: '',
      name: '',
      imageUrl: '',
      quantity: 1,
      currency: 'INR',
      priceAmount1000: 0
    };
    
    currentOrderItems.push(item);
    renderOrderItems();
  }
  
  function removeOrderItem(index) {
    currentOrderItems.splice(index, 1);
    renderOrderItems();
  }
  
  function updateOrderItem(index, field, value) {
    currentOrderItems[index][field] = value;
  }
  
  function renderOrderItems() {
    const container = document.getElementById('order-items-list');
    if (!container) return;
    
    container.innerHTML = currentOrderItems.map((item, index) => `
      <div style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 1rem; margin-bottom: 1rem; background: #f9fafb;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
          <h4 style="margin: 0; font-size: 0.875rem; font-weight: 600;">Item ${index + 1}</h4>
          <button type="button" 
                  onclick="window.templateFunctions.removeOrderItem(${index})"
                  class="remove-btn">
            Remove
          </button>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem;">
          <div>
            <label style="display: block; font-size: 0.75rem; margin-bottom: 0.25rem; color: #6b7280;">Product ID *</label>
            <input type="text" 
                   value="${item.productId}" 
                   onchange="window.templateFunctions.updateOrderItem(${index}, 'productId', this.value)"
                   placeholder="PROD-001"
                   style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.875rem;">
          </div>
          
          <div>
            <label style="display: block; font-size: 0.75rem; margin-bottom: 0.25rem; color: #6b7280;">Product Name *</label>
            <input type="text" 
                   value="${item.name}" 
                   onchange="window.templateFunctions.updateOrderItem(${index}, 'name', this.value)"
                   placeholder="Product Name"
                   style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.875rem;">
          </div>
          
          <div style="grid-column: 1 / -1;">
            <label style="display: block; font-size: 0.75rem; margin-bottom: 0.25rem; color: #6b7280;">Image URL</label>
            <input type="url" 
                   value="${item.imageUrl}" 
                   onchange="window.templateFunctions.updateOrderItem(${index}, 'imageUrl', this.value)"
                   placeholder="https://example.com/product.jpg"
                   style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.875rem;">
          </div>
          
          <div>
            <label style="display: block; font-size: 0.75rem; margin-bottom: 0.25rem; color: #6b7280;">Quantity *</label>
            <input type="number" 
                   value="${item.quantity}" 
                   onchange="window.templateFunctions.updateOrderItem(${index}, 'quantity', parseInt(this.value))"
                   min="1"
                   style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.875rem;">
          </div>
          
          <div>
            <label style="display: block; font-size: 0.75rem; margin-bottom: 0.25rem; color: #6b7280;">Price (Actual) *</label>
            <input type="number" 
                   value="${item.priceAmount1000 / 1000}" 
                   onchange="window.templateFunctions.updateOrderItem(${index}, 'priceAmount1000', parseFloat(this.value) * 1000)"
                   step="0.01"
                   placeholder="4999"
                   style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.875rem;">
          </div>
        </div>
      </div>
    `).join('');
  }
  
  // List management
  let currentSections = [];
  
  function addSection() {
    const section = {
      title: '',
      rows: []
    };
    
    currentSections.push(section);
    renderSections();
  }
  
  function removeSection(index) {
    currentSections.splice(index, 1);
    renderSections();
  }
  
  function addRow(sectionIndex) {
    if (!currentSections[sectionIndex].rows) {
      currentSections[sectionIndex].rows = [];
    }
    
    currentSections[sectionIndex].rows.push({
      id: `row_${Date.now()}`,
      title: '',
      description: ''
    });
    
    renderSections();
  }
  
  function removeRow(sectionIndex, rowIndex) {
    currentSections[sectionIndex].rows.splice(rowIndex, 1);
    renderSections();
  }
  
  function updateSectionField(sectionIndex, field, value) {
    currentSections[sectionIndex][field] = value;
  }
  
  function updateRowField(sectionIndex, rowIndex, field, value) {
    currentSections[sectionIndex].rows[rowIndex][field] = value;
  }
  
  function renderSections() {
    const container = document.getElementById('sections-list');
    if (!container) return;
    
    container.innerHTML = currentSections.map((section, sIndex) => `
      <div class="section-item">
        <div class="section-item-header">
          <h4>Section ${sIndex + 1}</h4>
          <button type="button" class="remove-btn" onclick="window.templateFunctions.removeSection(${sIndex})">Remove</button>
        </div>
        
        <div style="margin-bottom: 0.75rem;">
          <label style="display: block; font-size: 0.875rem; margin-bottom: 0.25rem;">Section Title *</label>
          <input type="text" 
                 value="${section.title}" 
                 onchange="window.templateFunctions.updateSectionField(${sIndex}, 'title', this.value)"
                 placeholder="e.g., Products"
                 style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
        </div>
        
        <div>
          <label style="display: block; font-size: 0.875rem; margin-bottom: 0.5rem; font-weight: 600;">Rows</label>
          ${(section.rows || []).map((row, rIndex) => `
            <div class="row-item">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                <span style="font-size: 0.75rem; font-weight: 600; color: #6b7280;">Row ${rIndex + 1}</span>
                <button type="button" 
                        onclick="window.templateFunctions.removeRow(${sIndex}, ${rIndex})"
                        style="background: #fee2e2; color: #dc2626; border: none; padding: 0.125rem 0.5rem; border-radius: 4px; font-size: 0.75rem; cursor: pointer;">
                  Remove
                </button>
              </div>
              
              <div style="margin-bottom: 0.5rem;">
                <input type="text" 
                       value="${row.title}" 
                       onchange="window.templateFunctions.updateRowField(${sIndex}, ${rIndex}, 'title', this.value)"
                       placeholder="Row title"
                       style="width: 100%; padding: 0.375rem; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.875rem;">
              </div>
              
              <div>
                <input type="text" 
                       value="${row.description || ''}" 
                       onchange="window.templateFunctions.updateRowField(${sIndex}, ${rIndex}, 'description', this.value)"
                       placeholder="Row description (optional)"
                       style="width: 100%; padding: 0.375rem; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.875rem;">
              </div>
            </div>
          `).join('')}
          
          <button type="button" 
                  onclick="window.templateFunctions.addRow(${sIndex})" 
                  class="btn-secondary-template" 
                  style="margin-top: 0.5rem; font-size: 0.875rem; padding: 0.5rem 1rem;">
            + Add Row
          </button>
        </div>
      </div>
    `).join('');
  }

  // Expose functions globally
  window.templateFunctions = {
    loadTemplates,
    switchTab,
    displayTemplates,
    selectTemplate,
    openCreateModal,
    closeModal,
    editTemplate,
    handleTypeChange,
    addVariable,
    addPollOption,
    removePollOption,
    updatePollOption,
    addOrderItem,
    removeOrderItem,
    updateOrderItem,
    addSection,
    removeSection,
    addRow,
    removeRow,
    updateSectionField,
    updateRowField,
    removeVariable,
    saveTemplate,
    openSendModal,
    closeSendModal,
    sendTemplate,
    deleteTemplate
  };

  console.log('Template functions registered');
})();
</script>
