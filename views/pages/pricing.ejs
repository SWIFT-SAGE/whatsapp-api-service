<!-- Pricing View -->
    <div id="pricing-view" class="view">
        <div class="pricing-container py-5">
            <div class="container py-4">
                <div class="row text-center mb-5 pb-3">
                    <div class="col-lg-8 mx-auto">
                        <h1 class="display-4 fw-bold mb-4">Choose Your Plan</h1>
                        <p class="lead text-muted mb-0">Start free and scale as you grow</p>
                    </div>
                </div>
                <div class="d-flex justify-content-center gap-3 mb-5">
                    <button class="btn btn-outline-primary btn-sm px-4 py-2 active" type="button">Monthly</button>
                    <button class="btn btn-outline-secondary btn-sm px-4 py-2" type="button">Yearly – Save 20%</button>
                </div>
                <div class="row g-4 justify-content-center mb-5">
                    <% plans.forEach((plan, index) => { %>
                    <div class="col-lg-4">
                        <div class="pricing-card <%= plan.name === 'Basic' ? 'popular' : '' %>">
                            <% if (plan.name === 'Basic') { %>
                            <div class="popular-badge">Most Popular</div>
                            <% } %>
                            <div class="pricing-header">
                                <h4><%= plan.name %></h4>
                                <div class="price">
                                    <% if (plan.name === 'Free') { %>
                                        <span class="amount">Free</span>
                                        <span class="period">Forever</span>
                                    <% } else { %>
                                        <span class="amount monthly-price">$<%= plan.monthlyPrice %></span>
                                        <span class="amount yearly-price" style="display: none;">$<%= Math.round(plan.yearlyPrice / 12) %></span>
                                        <span class="period monthly-period">/month</span>
                                        <span class="period yearly-period" style="display: none;">/month (billed yearly)</span>
                                        <div class="yearly-savings" style="display: none;">
                                            <small class="text-success">Save $<%= (plan.monthlyPrice * 12) - plan.yearlyPrice %>/year</small>
                                        </div>
                                    <% } %>
                                </div>
                            </div>
                            <ul class="pricing-features">
                                <% plan.features.forEach(feature => { %>
                                <li><i class="fas fa-check"></i><%= feature %></li>
                                <% }); %>
                            </ul>
                            <% if (user && user.subscription && user.subscription.plan === plan.name.toLowerCase()) { %>
                                <button class="btn btn-success w-100" disabled>
                                    <i class="fas fa-check me-2"></i>Current Plan
                                </button>
                            <% } else if (plan.name === 'Free') { %>
                                <button class="btn btn-outline-primary w-100">Get Started</button>
                            <% } else { %>
                                <button class="btn <%= plan.name === 'Basic' ? 'btn-primary' : 'btn-outline-primary' %> w-100" 
                                        data-action="upgrade" data-plan="<%= plan.name.toLowerCase() %>">
                                    Upgrade Now
                                </button>
                            <% } %>
                        </div>
                    </div>
                    <% }); %>
                </div>
                <div class="text-center mt-5 pt-3">
                    <small class="text-muted">All paid plans include a 14‑day free trial. Cancel anytime.</small>
                </div>

                <!-- FAQ Section -->
                <div class="row mt-5 pt-5">
                    <div class="col-lg-10 mx-auto">
                        <h2 class="text-center mb-5 pb-2">Frequently Asked Questions</h2>
                        <div class="accordion" id="pricingFAQ">
                            <div class="accordion-item mb-3 border rounded-3 shadow-sm">
                                <h2 class="accordion-header" id="headingOne">
                                    <button class="accordion-button py-3 px-4" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne">
                                        <i class="fas fa-credit-card me-3"></i>
                                        What payment methods do you accept?
                                    </button>
                                </h2>
                                <div id="collapseOne" class="accordion-collapse collapse show" data-bs-parent="#pricingFAQ">
                                    <div class="accordion-body py-3 px-4">
                                        We accept all major credit cards (Visa, MasterCard, American Express), PayPal, and bank transfers for annual plans. All payments are processed securely through Stripe.
                                    </div>
                                </div>
                            </div>
                            
                            <div class="accordion-item mb-3 border rounded-3 shadow-sm">
                                <h2 class="accordion-header" id="headingTwo">
                                    <button class="accordion-button collapsed py-3 px-4" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTwo">
                                        <i class="fas fa-exchange-alt me-3"></i>
                                        Can I upgrade or downgrade my plan anytime?
                                    </button>
                                </h2>
                                <div id="collapseTwo" class="accordion-collapse collapse" data-bs-parent="#pricingFAQ">
                                    <div class="accordion-body py-3 px-4">
                                        Yes! You can upgrade or downgrade your plan at any time. When upgrading, you'll be charged the prorated difference immediately. When downgrading, the change takes effect at your next billing cycle, and you'll receive account credit for the difference.
                                    </div>
                                </div>
                            </div>
                            
                            <div class="accordion-item mb-3 border rounded-3 shadow-sm">
                                <h2 class="accordion-header" id="headingThree">
                                    <button class="accordion-button collapsed py-3 px-4" type="button" data-bs-toggle="collapse" data-bs-target="#collapseThree">
                                        <i class="fas fa-calendar-times me-3"></i>
                                        What happens if I exceed my plan limits?
                                    </button>
                                </h2>
                                <div id="collapseThree" class="accordion-collapse collapse" data-bs-parent="#pricingFAQ">
                                    <div class="accordion-body py-3 px-4">
                                        If you exceed your monthly message limit, additional messages are charged at $0.01 per message. For API requests, we'll throttle your requests but won't charge extra. We'll notify you when you're approaching your limits and suggest upgrading if needed.
                                    </div>
                                </div>
                            </div>
                            
                            <div class="accordion-item mb-3 border rounded-3 shadow-sm">
                                <h2 class="accordion-header" id="headingFour">
                                    <button class="accordion-button collapsed py-3 px-4" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFour">
                                        <i class="fas fa-shield-alt me-3"></i>
                                        Is there a free trial available?
                                    </button>
                                </h2>
                                <div id="collapseFour" class="accordion-collapse collapse" data-bs-parent="#pricingFAQ">
                                    <div class="accordion-body py-3 px-4">
                                        Yes! All paid plans come with a 14-day free trial. No credit card required to start. You can test all features and send up to 100 messages during your trial period. Cancel anytime during the trial with no charges.
                                    </div>
                                </div>
                            </div>
                            
                            <div class="accordion-item mb-3 border rounded-3 shadow-sm">
                                <h2 class="accordion-header" id="headingFive">
                                    <button class="accordion-button collapsed py-3 px-4" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFive">
                                        <i class="fas fa-users me-3"></i>
                                        Do you offer team or enterprise plans?
                                    </button>
                                </h2>
                                <div id="collapseFive" class="accordion-collapse collapse" data-bs-parent="#pricingFAQ">
                                    <div class="accordion-body py-3 px-4">
                                        Yes! We offer custom solutions for teams with higher volume needs. Our Pro plan supports up to 2 chatbots and unlimited API messages. For larger teams requiring more chatbots or custom integrations, please contact our sales team for a custom quote.
                                    </div>
                                </div>
                            </div>
                            
                            <div class="accordion-item mb-3 border rounded-3 shadow-sm">
                                <h2 class="accordion-header" id="headingSix">
                                    <button class="accordion-button collapsed py-3 px-4" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSix">
                                        <i class="fas fa-question-circle me-3"></i>
                                        What's included in priority support?
                                    </button>
                                </h2>
                                <div id="collapseSix" class="accordion-collapse collapse" data-bs-parent="#pricingFAQ">
                                    <div class="accordion-body py-3 px-4">
                                        Priority support includes faster response times (within 4 hours), dedicated support channels, phone support, and priority bug fixes. Premium plan users also get access to our technical integration specialists for custom implementations.
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Plan Comparison Table -->
                <div class="row mt-5 pt-5 mb-5">
                    <div class="col-lg-11 mx-auto">
                        <h2 class="text-center mb-5 pb-2">Detailed Plan Comparison</h2>
                        <div class="table-responsive shadow-lg rounded-3 overflow-hidden" style="border: 1px solid rgba(0,0,0,0.08);">
                            <table class="table table-hover mb-0" style="background: white;">
                                <thead style="background: linear-gradient(135deg, var(--color-teal-500) 0%, var(--color-teal-600) 100%);">
                                    <tr>
                                        <th class="py-4 px-4 text-white" style="font-weight: 600; font-size: 15px; border: none;">Feature</th>
                                        <th class="py-4 px-4 text-center text-white" style="font-weight: 600; font-size: 15px; border: none;">Free</th>
                                        <th class="py-4 px-4 text-center text-white position-relative" style="font-weight: 600; font-size: 15px; border: none; background: rgba(255,255,255,0.1);">
                                            Basic
                                            <span class="badge bg-warning text-dark position-absolute top-0 end-0 m-2" style="font-size: 10px;">Popular</span>
                                        </th>
                                        <th class="py-4 px-4 text-center text-white" style="font-weight: 600; font-size: 15px; border: none;">Pro</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr style="border-bottom: 1px solid rgba(0,0,0,0.05);">
                                        <td class="py-3 px-4" style="font-weight: 600; color: var(--color-slate-900);"><i class="fas fa-paper-plane me-2" style="color: var(--color-teal-500); width: 20px;"></i>API Messages</td>
                                        <td class="py-3 px-4 text-center" style="color: var(--color-slate-500);">5 total</td>
                                        <td class="py-3 px-4 text-center" style="background: rgba(33, 128, 141, 0.03); font-weight: 500;">100,000/month</td>
                                        <td class="py-3 px-4 text-center" style="color: var(--color-teal-600); font-weight: 600;">Unlimited</td>
                                    </tr>
                                    <tr style="border-bottom: 1px solid rgba(0,0,0,0.05);">
                                        <td class="py-3 px-4" style="font-weight: 600; color: var(--color-slate-900);"><i class="fas fa-robot me-2" style="color: var(--color-teal-500); width: 20px;"></i>Bot Messages</td>
                                        <td class="py-3 px-4 text-center" style="color: var(--color-slate-500);">0</td>
                                        <td class="py-3 px-4 text-center" style="background: rgba(33, 128, 141, 0.03); font-weight: 500;">100,000/month</td>
                                        <td class="py-3 px-4 text-center" style="font-weight: 500;">10,000/month</td>
                                    </tr>
                                    <tr style="border-bottom: 1px solid rgba(0,0,0,0.05);">
                                        <td class="py-3 px-4" style="font-weight: 600; color: var(--color-slate-900);"><i class="fas fa-comments me-2" style="color: var(--color-teal-500); width: 20px;"></i>Chatbots</td>
                                        <td class="py-3 px-4 text-center" style="color: var(--color-slate-500);">1</td>
                                        <td class="py-3 px-4 text-center" style="background: rgba(33, 128, 141, 0.03); font-weight: 500;">1</td>
                                        <td class="py-3 px-4 text-center" style="font-weight: 500;">2</td>
                                    </tr>
                                    <tr style="border-bottom: 1px solid rgba(0,0,0,0.05);">
                                        <td class="py-3 px-4" style="font-weight: 600; color: var(--color-slate-900);"><i class="fas fa-tachometer-alt me-2" style="color: var(--color-teal-500); width: 20px;"></i>API Requests/minute</td>
                                        <td class="py-3 px-4 text-center" style="color: var(--color-slate-500);">5</td>
                                        <td class="py-3 px-4 text-center" style="background: rgba(33, 128, 141, 0.03); font-weight: 500;">1,000</td>
                                        <td class="py-3 px-4 text-center" style="color: var(--color-teal-600); font-weight: 600;">10,000</td>
                                    </tr>
                                    <tr style="border-bottom: 1px solid rgba(0,0,0,0.05);">
                                        <td class="py-3 px-4" style="font-weight: 600; color: var(--color-slate-900);"><i class="fas fa-webhook me-2" style="color: var(--color-teal-500); width: 20px;"></i>Webhook Support</td>
                                        <td class="py-3 px-4 text-center"><i class="fas fa-times-circle" style="color: #dc3545; font-size: 18px;"></i></td>
                                        <td class="py-3 px-4 text-center" style="background: rgba(33, 128, 141, 0.03);"><i class="fas fa-check-circle" style="color: #28a745; font-size: 18px;"></i></td>
                                        <td class="py-3 px-4 text-center"><i class="fas fa-check-circle" style="color: #28a745; font-size: 18px;"></i></td>
                                    </tr>
                                    <tr style="border-bottom: 1px solid rgba(0,0,0,0.05);">
                                        <td class="py-3 px-4" style="font-weight: 600; color: var(--color-slate-900);"><i class="fas fa-chart-line me-2" style="color: var(--color-teal-500); width: 20px;"></i>Analytics & Reporting</td>
                                        <td class="py-3 px-4 text-center" style="color: var(--color-slate-500);">Basic</td>
                                        <td class="py-3 px-4 text-center" style="background: rgba(33, 128, 141, 0.03); font-weight: 500;">Advanced</td>
                                        <td class="py-3 px-4 text-center" style="color: var(--color-teal-600); font-weight: 600;">Premium + Export</td>
                                    </tr>
                                    <tr style="border-bottom: 1px solid rgba(0,0,0,0.05);">
                                        <td class="py-3 px-4" style="font-weight: 600; color: var(--color-slate-900);"><i class="fas fa-headset me-2" style="color: var(--color-teal-500); width: 20px;"></i>Support</td>
                                        <td class="py-3 px-4 text-center" style="color: var(--color-slate-500);">Community</td>
                                        <td class="py-3 px-4 text-center" style="background: rgba(33, 128, 141, 0.03); font-weight: 500;">Email (24h)</td>
                                        <td class="py-3 px-4 text-center" style="color: var(--color-teal-600); font-weight: 600;">Priority (4h)</td>
                                    </tr>
                                    <tr>
                                        <td class="py-3 px-4" style="font-weight: 600; color: var(--color-slate-900); border: none;"><i class="fas fa-puzzle-piece me-2" style="color: var(--color-teal-500); width: 20px;"></i>Custom Integrations</td>
                                        <td class="py-3 px-4 text-center" style="border: none;"><i class="fas fa-times-circle" style="color: #dc3545; font-size: 18px;"></i></td>
                                        <td class="py-3 px-4 text-center" style="background: rgba(33, 128, 141, 0.03); border: none;"><i class="fas fa-times-circle" style="color: #dc3545; font-size: 18px;"></i></td>
                                        <td class="py-3 px-4 text-center" style="border: none;"><i class="fas fa-check-circle" style="color: #28a745; font-size: 18px;"></i></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Pricing page functionality
        document.addEventListener('DOMContentLoaded', function() {
            // Plan selection handling
            document.querySelectorAll('[data-action="upgrade"]').forEach(button => {
                button.addEventListener('click', async function() {
                    const planName = this.getAttribute('data-plan');
                    const planPrice = this.textContent.includes('$') ? this.textContent.match(/\$([0-9]+)/)?.[1] : '0';
                    
                    // Check if user is logged in
                    const isLoggedIn = <%= user ? 'true' : 'false' %>;
                    if (!isLoggedIn) {
                        if (confirm(`Please login to select the ${planName} plan. Redirect to login?`)) {
                            window.location.href = '/login?redirect=/pricing';
                        }
                        return;
                    }
                    
                    // Show confirmation modal
                    if (confirm(`Are you sure you want to upgrade to the ${planName} plan?`)) {
                        try {
                            // Disable button and show loading
                            const originalText = this.innerHTML;
                            this.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Processing...';
                            this.disabled = true;
                            
                            const response = await fetch('/api/billing/subscribe', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({
                                    planName: planName,
                                    billingCycle: 'monthly'
                                })
                            });
                            
                            const data = await response.json();
                            
                            if (response.ok) {
                                if (data.checkoutUrl) {
                                    // Redirect to payment processor
                                    window.location.href = data.checkoutUrl;
                                } else {
                                    alert('Plan updated successfully!');
                                    location.reload();
                                }
                            } else {
                                alert('Error selecting plan: ' + (data.message || 'Please try again.'));
                                this.innerHTML = originalText;
                                this.disabled = false;
                            }
                        } catch (error) {
                            alert('Error selecting plan. Please try again.');
                            this.innerHTML = originalText;
                            this.disabled = false;
                        }
                    }
                });
            });
            
            // Get Started button handling
            document.querySelectorAll('.btn-outline-primary').forEach(button => {
                if (button.textContent.includes('Get Started')) {
                    button.addEventListener('click', function() {
                        const isLoggedIn = <%= user ? 'true' : 'false' %>;
                        if (!isLoggedIn) {
                            window.location.href = '/register';
                        } else {
                            window.location.href = '/dashboard';
                        }
                    });
                }
            });
            
            // Billing toggle (monthly/yearly)
            const monthlyBtn = document.querySelector('.d-flex.justify-content-center .btn-outline-primary.active');
            const yearlyBtn = document.querySelector('.d-flex.justify-content-center .btn-outline-secondary');
            
            if (monthlyBtn && yearlyBtn) {
                monthlyBtn.addEventListener('click', function() {
                    this.classList.add('active');
                    this.classList.remove('btn-outline-primary');
                    this.classList.add('btn-primary');
                    yearlyBtn.classList.remove('active', 'btn-primary');
                    yearlyBtn.classList.add('btn-outline-secondary');
                    updatePricing('monthly');
                });
                
                yearlyBtn.addEventListener('click', function() {
                    this.classList.add('active');
                    this.classList.remove('btn-outline-secondary');
                    this.classList.add('btn-primary');
                    monthlyBtn.classList.remove('active', 'btn-primary');
                    monthlyBtn.classList.add('btn-outline-primary');
                    updatePricing('yearly');
                });
            }
            
            function updatePricing(cycle) {
                // Update pricing display based on monthly/yearly selection
                document.querySelectorAll('.monthly-price, .yearly-price').forEach(element => {
                    if (cycle === 'yearly') {
                        if (element.classList.contains('monthly-price')) {
                            element.style.display = 'none';
                        } else {
                            element.style.display = 'inline';
                        }
                    } else {
                        if (element.classList.contains('monthly-price')) {
                            element.style.display = 'inline';
                        } else {
                            element.style.display = 'none';
                        }
                    }
                });
                
                document.querySelectorAll('.monthly-period, .yearly-period').forEach(element => {
                    if (cycle === 'yearly') {
                        if (element.classList.contains('monthly-period')) {
                            element.style.display = 'none';
                        } else {
                            element.style.display = 'inline';
                        }
                    } else {
                        if (element.classList.contains('monthly-period')) {
                            element.style.display = 'inline';
                        } else {
                            element.style.display = 'none';
                        }
                    }
                });
                
                document.querySelectorAll('.yearly-savings').forEach(element => {
                    element.style.display = cycle === 'yearly' ? 'block' : 'none';
                });
            }
            
            // Load user's current subscription status
            const isLoggedIn =  (typeof user !== 'undefined' && user) ? 'true' : 'false' ;
            if (isLoggedIn) {
                loadSubscriptionStatus();
            }
        });
        
        // Load subscription status
        async function loadSubscriptionStatus() {
            try {
                const response = await fetch('/api/billing/subscription-status');
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.subscription) {
                        // Show billing info
                        if (data.subscription.nextBillingDate) {
                            const billingInfo = document.createElement('div');
                            billingInfo.className = 'alert alert-info mt-4';
                            billingInfo.innerHTML = `
                                <i class="fas fa-info-circle me-2"></i>
                                <strong>Current Subscription:</strong> ${data.subscription.planName}<br>
                                <strong>Next Billing Date:</strong> ${new Date(data.subscription.nextBillingDate).toLocaleDateString()}<br>
                                <strong>Status:</strong> ${data.subscription.status}
                            `;
                            document.querySelector('.pricing-container .container').prepend(billingInfo);
                        }
                    }
                }
            } catch (error) {
            }
        }
    </script>

